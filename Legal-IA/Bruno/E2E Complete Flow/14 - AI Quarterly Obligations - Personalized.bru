meta {
  name: 14 - AI Quarterly Obligations - Personalized
  type: http
  seq: 14
}

post {
  url: {{baseUrl}}/ai/quarterly-obligations
  body: json
  auth: bearer
}

auth:bearer {
  token: {{jwtToken}}
}

body:json {
  {
    "quarter": {{currentQuarter}},
    "year": {{currentYear}},
    "userId": "{{userId}}"
  }
}

tests {
  test("Should provide personalized quarterly obligations", function() {
    expect(res.getStatus()).to.equal(200);
  });
  
  test("Should contain user-specific financial guidance", function() {
    const responseJson = res.getBody();
    const answer = responseJson.toLowerCase();
    
    // Should mention user by name
    expect(answer).to.satisfy(function(text) {
      return text.includes('carlos') || text.includes('garcÃ­a');
    });
    
    // Should reference actual amounts or business data
    expect(answer).to.satisfy(function(text) {
      return text.includes('â‚¬') || text.includes('madrid') || text.includes('consultorÃ­a') || text.includes('segÃºn sus ingresos');
    });
  });
  
  test("Should mention modelo 347 obligation", function() {
    const responseJson = res.getBody();
    const answer = responseJson.toLowerCase();
    // With â‚¬17,900 revenue, should mention modelo 347 (threshold â‚¬3,005.06)
    expect(answer).to.include('347');
  });
  
  test("Should provide specific deadlines", function() {
    const responseJson = res.getBody();
    const answer = responseJson.toLowerCase();
    expect(answer).to.satisfy(function(text) {
      return text.includes('enero') || text.includes('abril') || text.includes('julio') || text.includes('octubre') || text.includes('plazo');
    });
  });
}

script:post-response {
  if (res.status === 200) {
    const response = res.body;
    console.log("ðŸ“… AI Quarterly Obligations:");
    console.log("âœ… Mentions user name: " + (response.toLowerCase().includes('carlos') ? 'YES' : 'NO'));
    console.log("âœ… Mentions modelo 347: " + (response.toLowerCase().includes('347') ? 'YES' : 'NO'));
    console.log("âœ… Contains financial amounts: " + (response.includes('â‚¬') ? 'YES' : 'NO'));
  }
}
