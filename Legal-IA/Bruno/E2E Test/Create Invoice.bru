meta {
  name: Create Invoice
  type: http
  seq: 4
}

post {
  url: {{baseUrl}}/invoices/user
  body: json
  auth: inherit
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "invoiceNumber": "INV-{{$timestamp}}",
    "issueDate": "{{$isoTimestamp}}",
    "clientName": "{{$randomFullName}}",
    "clientNIF": "{{randomDni}}",
    "clientAddress": "{{$randomStreetAddress}}",
    "subtotal": {{$randomPrice}},
    "VAT": "{{randomVat}}",
    "IRPF": "{{randomIrpf}}",
    "total": "{{randomTotal}}",
    "notes": "{{$randomLoremSentence}}",
    "items": []
  }
}

script:pre-request {
  function randomDni() {
    const letters = 'TRWAGMYFPDXBNJZSQVHLCKE'; // checksum map
    const n = Math.floor(Math.random() * 100000000); // 0..99,999,999
    const numStr = n.toString().padStart(8, '0');    // 8 digits
    const letter = letters[n % 23];
    return `${numStr}${letter}`;
  }
  
  const vat = bru.interpolate("{{$randomPrice}}")
  const irpf = bru.interpolate("{{$randomPrice}}")
  const total = parseInt(vat) + parseInt(irpf)
  const randomClientNif = randomDni();
  bru.setEnvVar("randomVat",vat)
  bru.setEnvVar("randomIrpf",irpf)
  bru.setEnvVar("randomTotal",total)
  bru.setEnvVar("randomDni",randomClientNif)
}

script:post-response {
  // Set invoiceId
  console.log("Set invoiceId to: " + res.getBody().id);
  bru.setEnvVar("invoiceId", res.getBody().id);
}

settings {
  encodeUrl: true
}
